<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Legal Docx Uploader</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5e9;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #5e564f;
    }

    h1 {
      font-size: 36px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .upload-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 600px;
      width: 100%;
      align-items: center;
    }

    .upload-btn {
      background: #8b4513;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      text-align: center;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px;
    }

    .upload-btn:hover {
      background: #a0522d;
    }

    .upload-input {
      display: none;
    }

    #okBtn {
      background: #5e564f;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px;
    }

    #okBtn:hover {
      background: #736963;
    }

    #downloadBtn {
      display: none;
      background: #5e564f;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
      transition: background 0.3s;
      width: 100%;
      max-width: 200px;
    }

    #downloadBtn:hover {
      background: #736963;
    }

    #status {
      margin-top: 10px;
      font-size: 14px;
      color: #5e564f;
      text-align: center;
      min-height: 20px;
      max-width: 600px;
      word-wrap: break-word;
    }

    .token-container {
      margin-bottom: 20px;
      width: 100%;
      max-width: 600px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #tokenInput {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    #saveTokenBtn {
      background: #5e564f;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    #saveTokenBtn:hover {
      background: #736963;
    }
  </style>
</head>

<body>
  <h1>Legal Docx Uploader</h1>
  <div class="token-container" id="tokenContainer">
    <input id="tokenInput" type="password" placeholder="Nhập GitHub Personal Access Token">
    <button id="saveTokenBtn" onclick="saveToken()">Lưu Token</button>
  </div>
  <div class="upload-container" id="uploadContainer" style="display: none;">
    <label class="upload-btn" for="file1">Upload 1</label>
    <input id="file1" class="upload-input" type="file" accept=".docx">
    <label class="upload-btn" for="file2">Upload 2</label>
    <input id="file2" class="upload-input" type="file" accept=".docx">
    <label class="upload-btn" for="file3">Upload 3</label>
    <input id="file3" class="upload-input" type="file" accept=".docx">
    <label class="upload-btn" for="file4">Upload 4</label>
    <input id="file4" class="upload-input" type="file" accept=".docx">
    <label class="upload-btn" for="file5">Upload 5</label>
    <input id="file5" class="upload-input" type="file" accept=".docx">
    <button id="okBtn" onclick="uploadFiles()">OK</button>
  </div>
  <div id="status"></div>
  <button id="downloadBtn" onclick="downloadResult()">Download training_data.txt</button>

  <script>
    const REPO = "raydoanhuy/docx-cleaner";
    let GITHUB_TOKEN = "";
    let uploadedCount = 0;
    let selectedFiles = [];

    // Kiểm tra token khi trang tải
    document.addEventListener('DOMContentLoaded', () => {
      const token = sessionStorage.getItem('github_token');
      if (token) {
        validateToken(token); // Kiểm tra token đã lưu
      } else {
        showTokenSection(); // Hiển thị ô token
      }
    });

    // Hiển thị ô token, ẩn upload
    function showTokenSection() {
      document.getElementById('tokenContainer').style.display = 'flex';
      document.getElementById('uploadContainer').style.display = 'none';
      document.getElementById('status').textContent = '';
    }

    // Hiển thị upload, ẩn ô token
    function showUploadSection() {
      document.getElementById('tokenContainer').style.display = 'none';
      document.getElementById('uploadContainer').style.display = 'block';
      document.getElementById('downloadBtn').style.display = 'none';
      document.getElementById('status').textContent = 'Chọn file và nhấn OK để upload.';
    }

    // Hiển thị lỗi
    function showStatus(message, isError = false) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.style.color = isError ? 'red' : '#5e564f';
    }

    // Kiểm tra và lưu token
    async function saveToken() {
      const tokenInput = document.getElementById('tokenInput').value.trim();
      if (!tokenInput) {
        showStatus('Vui lòng nhập token!', true);
        return;
      }
      await validateToken(tokenInput);
    }

    // Xác thực token
    async function validateToken(token) {
      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        if (response.ok) {
          GITHUB_TOKEN = token;
          sessionStorage.setItem('github_token', token);
          showUploadSection();
        } else {
          sessionStorage.removeItem('github_token');
          GITHUB_TOKEN = '';
          showStatus('Token không hợp lệ. Vui lòng thử lại.', true);
        }
      } catch (error) {
        sessionStorage.removeItem('github_token');
        GITHUB_TOKEN = '';
        showStatus('Lỗi kiểm tra token: ' + error.message, true);
      }
    }

    document.querySelectorAll(".upload-input").forEach((input, index) => {
      input.addEventListener("change", () => {
        const file = input.files[0];
        if (file && file.name.toLowerCase().endswith(".docx")) {
          selectedFiles[index] = file;
          showStatus(`Đã chọn file ${file.name} cho Upload ${index + 1}.`);
        } else {
          showStatus(`Upload ${index + 1}: Vui lòng chọn file .docx!`, true);
          selectedFiles[index] = null;
        }
      });
    });

    async function uploadFiles() {
      const statusEl = document.getElementById("status");
      if (!GITHUB_TOKEN) {
        showStatus("Vui lòng lưu token trước khi upload!", true);
        return;
      }

      const validFiles = selectedFiles.filter(file => file !== null);
      if (validFiles.length === 0) {
        showStatus("Vui lòng chọn ít nhất một file .docx!", true);
        return;
      }

      showStatus(`Đang upload ${validFiles.length} file...`);
      try {
        for (let i = 0; i < validFiles.length; i++) {
          const file = validFiles[i];
          const fileName = file.name; // Giữ tên file gốc
          const reader = new FileReader();
          await new Promise((resolve) => {
            reader.onload = async function (e) {
              const content = e.target.result.split(',')[1];
              console.log(`Uploading ${fileName}...`);
              const response = await fetch(`https://api.github.com/repos/${REPO}/contents/legal_docs/${fileName}`, {
                method: "PUT",
                headers: {
                  "Authorization": `Bearer ${GITHUB_TOKEN}`,
                  "Accept": "application/vnd.github.v3+json"
                },
                body: JSON.stringify({
                  message: `Upload ${fileName}`,
                  content: content,
                  branch: "main"
                })
              });
              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Upload ${fileName} thất bại: ${errorData.message || response.statusText}`);
              }
              console.log(`Uploaded ${fileName}`);
              uploadedCount++;
              showStatus(`Đã upload ${uploadedCount}/${validFiles.length} file...`);
              resolve();
            };
            reader.readAsDataURL(file);
          });
        }
        showStatus(`Đã upload ${uploadedCount} file. Đang chờ xử lý...`);
        checkWorkflowStatus();
      } catch (error) {
        console.error("Upload error:", error.message);
        showStatus(`Lỗi upload: ${error.message}`, true);
      }
    }

    async function checkWorkflowStatus() {
      try {
        console.log("Checking workflow status...");
        const response = await fetch(`https://api.github.com/repos/${REPO}/actions/runs`, {
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`,
            "Accept": "application/vnd.github.v3+json",
            "Cache-Control": "no-cache"
          }
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Kiểm tra workflow thất bại: ${errorData.message || response.statusText}`);
        }
        const data = await response.json();
        const latestRun = data.workflow_runs.find(run => run.name === "Process Docx Files");
        if (latestRun) {
          if (latestRun.status === "completed" && latestRun.conclusion === "success") {
            document.getElementById("downloadBtn").style.display = "block";
            showStatus("Xử lý hoàn tất! Nhấn Download để tải training_data.txt.");
            uploadedCount = 0;
            selectedFiles = [];
            document.querySelectorAll(".upload-input").forEach(input => input.value = "");
          } else {
            showStatus(`Đang xử lý (${uploadedCount} file), vui lòng chờ...`);
            setTimeout(checkWorkflowStatus, 5000);
          }
        } else {
          showStatus("Không tìm thấy workflow. Đang thử lại...");
          setTimeout(checkWorkflowStatus, 5000);
        }
      } catch (error) {
        console.error("Workflow check error:", error.message);
        showStatus(`Lỗi kiểm tra trạng thái: ${error.message}`, true);
      }
    }

    async function downloadResult() {
      try {
        console.log("Downloading training_data.txt...");
        const response = await fetch(`https://api.github.com/repos/${REPO}/contents/training_data.txt`, {
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`,
            "Accept": "application/vnd.github.v3+json",
            "Cache-Control": "no-cache"
          }
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`Không tải được training_data.txt: ${errorData.message || response.statusText}`);
        }
        const data = await response.json();
        const content = atob(data.content); // Giải mã base64
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "training_data.txt";
        a.click();
        window.URL.revokeObjectURL(url);
        showStatus("Đã tải training_data.txt!");
      } catch (error) {
        console.error("Download error:", error.message);
        showStatus(`Lỗi tải file: ${error.message}`, true);
      }
    }
  </script>
</body>

</html>
